!function(t,s,i){var o=function(s,i){this.$elem=t(s),this.$elem.data("instance",this),this.init(i)};o.prototype={defaults:{audioButtonClass:"ubaplayer-button",autoPlay:null,codecs:[{name:"OGG",codec:'audio/ogg; codecs="vorbis"'},{name:"MP3",codec:"audio/mpeg"}],continuous:!1,controlsClass:"ubaplayer-controls",extension:null,fallbackExtension:".mp3",fallbackFunctions:{error:null,pause:null,play:null,resume:null},flashAudioPlayerPath:"swf/player.swf",flashExtension:".mp3",flashObjectID:"ubaplayerflash",loadingClass:"ubaplayer-loading",loop:!1,playerContainer:"ubaplayer-container",playingClass:"ubaplayer-playing",swfobjectPath:"js/swfobject.js",volume:.5},isPlaying:!1,isFlash:!1,isFallback:!1,init:function(s){var i,o=this,n=0;for(this.options=t.extend(!0,{},this.defaults,s||{}),this.loadProxy=t.proxy(this.onLoaded,this),this.errorProxy=t.proxy(this.onError,this),this.endProxy=t.proxy(this.onEnded,this),this.progressProxy=t.proxy(this.onProgress,this),this.$buttons=t("."+this.options.audioButtonClass),i=this.options.codecs.length,t("."+this.options.controlsClass).on("touchend click","."+this.options.audioButtonClass,function(s){return o.unbound||"touchend"==s.type&&(t("."+o.options.controlsClass).off("click"),o.unbound=!0,console.log("unbound",s.type)),s.preventDefault(),o.updateTrackState(s),!1});i>n;n++){var a=this.options.codecs[n];if(this.canPlay(a)){this.options.extension=[".",a.name.toLowerCase()].join("");break}}(!this.options.extension||this.isFlash)&&(this.isFlash=!0,this.options.extension=this.options.flashExtension),this.isFlash?(this.$elem.html("<div id='"+this.options.playerContainer+"'></div>"),swfobject.embedSWF(this.options.flashAudioPlayerPath,this.options.playerContainer,"0","0","9.0.0",!1,!1,{AllowScriptAccess:"always"},{id:this.options.flashObjectID,name:this.options.flashObjectID},t.proxy(this.swfLoaded,this))):this.options.autoPlay&&this.play(this.options.autoPlay)},pause:function(){this.isFallback?"function"==typeof this.options.fallbackFunctions.pause&&this.options.fallbackFunctions.pause():this.isFlash?this.audio.pauseFlash():this.audio.pause(),this.$tgt.removeClass(this.options.playingClass),this.isPlaying=!1},play:function(i){this.$tgt="undefined"==typeof i?t("."+this.options.audioButtonClass).eq(0):i,this.currentTrack=this.getFileNameWithoutExtension(this.$tgt.attr("href")),this.isPlaying=!0,this.$tgt.addClass(this.options.loadingClass),this.$buttons.removeClass(this.options.playingClass),this.isFallback?"function"==typeof this.options.fallbackFunctions.play&&this.options.fallbackFunctions.play(this.currentTrack+this.options.fallbackExtension):this.isFlash?(this.audio&&this.removeListeners(s),this.audio=swfobject.getObjectById(this.options.flashObjectID),this.addListeners(s),this.audio.playFlash(this.currentTrack+this.options.extension)):(this.audio&&(this.removeListeners(this.audio),this.audio.pause()),this.audio=new Audio(""),this.addListeners(this.audio),this.audio.id="audio",this.audio.loop=this.options.loop?"loop":"",this.audio.volume=this.options.volume,this.audio.src=this.currentTrack+this.options.extension,this.audio.play())},playing:function(){return this.isPlaying},resume:function(){this.isFallback?"function"==typeof this.options.fallbackFunctions.resume&&this.options.fallbackFunctions.resume():this.isFlash?this.audio.playFlash():this.audio.play(),this.$tgt.addClass(this.options.playingClass),this.isPlaying=!0},updateTrackState:function(s){this.$tgt=t(s.target),this.$tgt.hasClass(this.options.audioButtonClass)&&(!this.audio||this.audio&&this.currentTrack!==this.getFileNameWithoutExtension(this.$tgt.attr("href"))?this.play(this.$tgt):this.isPlaying?this.pause():this.resume())},addListeners:function(s){var i=t(s);i.on("canplay",this.loadProxy),i.on("error",this.errorProxy),i.on("ended",this.endProxy),i.on("timeupdate",this.progressProxy)},removeListeners:function(s){var i=t(s);i.off("canplay",this.loadProxy),i.off("error",this.errorProxy),i.off("ended",this.endProxy),i.on("timeupdate",this.progressProxy)},onLoaded:function(){this.$buttons.removeClass(this.options.loadingClass),this.$tgt.addClass(this.options.playingClass),this.audio.play()},onError:function(){this.$buttons.removeClass(this.options.loadingClass),this.removeListeners(this.isFlash?s:this.audio)},onEnded:function(){if(this.isPlaying=!1,this.$tgt.removeClass(this.options.playingClass),this.currentTrack="",this.removeListeners(this.isFlash?s:this.audio),this.options.continuous){var i=this.$tgt.next().length?this.$tgt.next():t(this.options.audioButtonClass).eq(0);this.play(i)}},onProgress:function(i,o){var n=this.isFlash?JSON.parse(o):t(i.target)[0],a=Math.round(n.currentTime),e=Math.round(n.duration),h=a/e;t(s).trigger("ubaplayerProgress",{currentTime:a,duration:e,percentElapsed:h,track:this.currentTrack})},canPlay:function(t){return i.createElement("audio").canPlayType&&i.createElement("audio").canPlayType(t.codec).match(/maybe|probably/i)?!0:!1},swfLoaded:function(t){t.success||(this.isFlash=!1,this.isFallback=!0,"function"==typeof this.options.fallbackFunctions.error&&this.options.fallbackFunctions.error()),this.options.autoPlay&&setTimeout(function(){this.play(this.options.autoPlay)},500)},getFileNameWithoutExtension:function(t){var s=t.split(".");return s.pop(),s.join(".")}},t.fn.ubaPlayer=function(s,i){return this.each("string"==typeof s?function(){t(this).data("instance")[s](i)}:function(){new o(this,s)})}}(jQuery,window,document);
